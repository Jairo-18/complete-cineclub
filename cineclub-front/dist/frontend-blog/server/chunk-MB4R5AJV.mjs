import './polyfills.server.mjs';
import{a as Ce}from"./chunk-NLP2SREY.mjs";import"./chunk-TGSCDNAE.mjs";import{b as be,c as xe}from"./chunk-ZR6RAYMG.mjs";import{a as Ee,b as ye,c as ve}from"./chunk-GRXIXLG2.mjs";import{d as W}from"./chunk-SN4ZLEXK.mjs";import"./chunk-C7WF65TO.mjs";import{a as re}from"./chunk-KXZRHGC3.mjs";import{b as te}from"./chunk-IZYF7JLB.mjs";import"./chunk-POLO5U2S.mjs";import{b as _e,c as ge}from"./chunk-DMVK7NGP.mjs";import{D as fe,E as he,e as ie,g as _,j as oe,k as ae,o as ne,q as le,r as se,t as me,v as de,w as ue,x as ce,z as pe}from"./chunk-R2LPZPTP.mjs";import{l as K,m as Q,o as X}from"./chunk-37XX4R2Q.mjs";import{b as H,c as J}from"./chunk-QHGSIMU3.mjs";import"./chunk-3YY5WZBW.mjs";import{l as Y}from"./chunk-6XZJ4HF4.mjs";import"./chunk-BKMGEJ4V.mjs";import"./chunk-ABBCMJJI.mjs";import{c as L,f as $,g as Z}from"./chunk-5Y2PL6TA.mjs";import{a as ee}from"./chunk-TPI6FTCS.mjs";import{C as U,Db as A,Gb as F,Ib as b,La as n,O as N,Sb as D,V as P,Wb as a,Xa as k,Xb as j,Yb as g,Yc as B,_ as d,_c as G,c as T,da as S,db as q,ea as w,ic as z,jc as V,nb as u,nd as O,o as C,ob as c,qb as R,rb as M,sb as I,tb as h,ub as i,vb as t,wb as f}from"./chunk-I37AKPGM.mjs";import"./chunk-BPPYXBGU.mjs";import{h as p}from"./chunk-S6KH3LOX.mjs";var x=class o{generateRandomPassword(){let r="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*",l="";l+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random()*26)],l+="abcdefghijklmnopqrstuvwxyz"[Math.floor(Math.random()*26)],l+="0123456789"[Math.floor(Math.random()*10)],l+="!@#$%^&*"[Math.floor(Math.random()*8)];for(let m=l.length;m<16;m++)l+=r[Math.floor(Math.random()*r.length)];return l.split("").sort(()=>Math.random()-.5).join("")}static \u0275fac=function(r){return new(r||o)};static \u0275prov=P({token:o,factory:o.\u0275fac,providedIn:"root"})};var Ie=(o,e)=>e.id;function Fe(o,e){o&1&&(i(0,"div",8),f(1,"app-loader"),t())}function Te(o,e){o&1&&(i(0,"mat-error"),a(1,"El nombre completo es requerido"),t())}function Ue(o,e){o&1&&(i(0,"mat-error"),a(1,"El correo es requerido"),t())}function Ne(o,e){o&1&&(i(0,"mat-error"),a(1,"Ingresa un correo v\xE1lido"),t())}function Pe(o,e){o&1&&(i(0,"mat-error"),a(1,"El tel\xE9fono es requerido"),t())}function ke(o,e){if(o&1&&(i(0,"mat-option",18),a(1),t()),o&2){let r=e.$implicit;h("value",r),n(),g(" ",r," ")}}function qe(o,e){o&1&&(i(0,"mat-error"),a(1,"El pa\xEDs es requerido"),t())}function Re(o,e){if(o&1&&(i(0,"mat-option",18),a(1),t()),o&2){let r=e.$implicit;h("value",r.id),n(),g(" ",r.name," ")}}function Ae(o,e){o&1&&(i(0,"mat-error"),a(1,"El rol es requerido"),t())}function De(o,e){o&1&&(i(0,"mat-form-field",11)(1,"mat-label"),a(2,"Bibliograf\xEDa"),t(),f(3,"textarea",25),i(4,"mat-icon",13),a(5,"description"),t()())}function je(o,e){o&1&&(i(0,"div",20)(1,"div",26)(2,"mat-icon",27),a(3,"info"),t(),i(4,"div")(5,"p",28),a(6,"Contrase\xF1a autom\xE1tica"),t(),i(7,"p",29),a(8," Se generar\xE1 una contrase\xF1a segura autom\xE1ticamente. Te la mostraremos despu\xE9s de crear el usuario. "),t()()()())}function ze(o,e){if(o&1){let r=A();i(0,"form",9)(1,"div",10)(2,"mat-form-field",11)(3,"mat-label"),a(4,"Nombre Completo"),t(),f(5,"input",12),i(6,"mat-icon",13),a(7,"person"),t(),u(8,Te,2,0,"mat-error"),t(),i(9,"mat-form-field",11)(10,"mat-label"),a(11,"Nombre de Usuario"),t(),f(12,"input",14),i(13,"mat-icon",13),a(14,"account_circle"),t()(),i(15,"mat-form-field",11)(16,"mat-label"),a(17,"Correo Electr\xF3nico"),t(),f(18,"input",15),i(19,"mat-icon",13),a(20,"email"),t(),u(21,Ue,2,0,"mat-error"),u(22,Ne,2,0,"mat-error"),t(),i(23,"mat-form-field",11)(24,"mat-label"),a(25,"Tel\xE9fono"),t(),f(26,"input",16),i(27,"mat-icon",13),a(28,"phone"),t(),u(29,Pe,2,0,"mat-error"),t(),i(30,"mat-form-field",11)(31,"mat-label"),a(32,"Pa\xEDs"),t(),f(33,"input",17),i(34,"mat-icon",13),a(35,"public"),t(),i(36,"mat-autocomplete",null,0),M(38,ke,2,2,"mat-option",18,R),z(40,"async"),t(),u(41,qe,2,0,"mat-error"),t(),i(42,"mat-form-field",11)(43,"mat-label"),a(44,"Rol"),t(),i(45,"mat-select",19),M(46,Re,2,2,"mat-option",18,Ie),t(),i(48,"mat-icon",13),a(49,"badge"),t(),u(50,Ae,2,0,"mat-error"),t()(),u(51,De,6,0,"mat-form-field",11),u(52,je,9,0,"div",20),i(53,"div",21)(54,"button",22),F("click",function(){S(r);let m=b();return w(m.cancel())}),a(55," Cancelar "),t(),i(56,"button",23),F("click",function(){S(r);let m=b();return w(m.saveUser())}),i(57,"mat-icon",24),a(58),t(),a(59),t()()()}if(o&2){let r,l,m,E,y,v,we=D(37),s=b();h("formGroup",s.userForm),n(8),c((r=s.userForm.get("fullName"))!=null&&r.hasError("required")?8:-1),n(13),c((l=s.userForm.get("email"))!=null&&l.hasError("required")?21:-1),n(),c((m=s.userForm.get("email"))!=null&&m.hasError("email")?22:-1),n(7),c((E=s.userForm.get("phone"))!=null&&E.hasError("required")?29:-1),n(4),h("matAutocomplete",we),n(5),I(V(40,14,s.filteredCountries)),n(3),c((y=s.userForm.get("country"))!=null&&y.hasError("required")?41:-1),n(5),I(s.roles),n(4),c((v=s.userForm.get("roleTypeId"))!=null&&v.hasError("required")?50:-1),n(),c(s.isEditMode?51:-1),n(),c(s.isEditMode?-1:52),n(2),h("disabled",s.loading),n(2),h("disabled",s.loading||s.userForm.invalid),n(2),j(s.isEditMode?"save":"person_add"),n(),g(" ",s.isEditMode?"Guardar Cambios":"Crear Usuario"," ")}}var Se=class o{userForm;loading=!1;isEditMode=!1;userId=null;countries=[];filteredCountries=new T;roles=[];_fb=d(me);_route=d(L);_router=d($);_http=d(O);_supabaseClient=d(ee);_userAdminService=d(Ce);_notificationsService=d(Y);_ramdomPassword=d(x);_ngZone=d(q);ngOnInit(){this.initializeForm(),this.loadCountries(),this.loadRoles(),this.checkMode()}initializeForm(){this.userForm=this._fb.group({fullName:["",[_.required]],username:[""],email:["",[_.required,_.email]],phone:["",[_.required]],country:["",[_.required]],roleTypeId:["",[_.required]],bibliography:[""]})}checkMode(){return p(this,null,function*(){this.userId=this._route.snapshot.paramMap.get("id"),this.userId&&this.userId!=="new"&&(this.isEditMode=!0,this._ngZone.run(()=>this.loadUserData()))})}loadUserData(){return p(this,null,function*(){if(this.userId)try{this.loading=!0;let{data:e,error:r}=yield this._supabaseClient.from("profile").select(`
        id,
        fullName,
        username,
        email,
        phone,
        country,
        roleTypeId,
        bibliography
      `).eq("id",this.userId).single();if(r)throw r;e&&this.userForm.patchValue({fullName:e.fullName,username:e.username,email:e.email,phone:e.phone,country:e.country,roleTypeId:e.roleTypeId,bibliography:e.bibliography||""})}catch(e){console.error("\u274C Error al cargar usuario:",e),this._notificationsService.error("No se pudo cargar el usuario."),this._router.navigate(["/organizational/see-users"])}finally{this._ngZone.run(()=>{this.loading=!1})}})}loadCountries(){return p(this,null,function*(){try{this._http.get("https://restcountries.com/v3.1/all?fields=name").pipe(C(e=>e.map(r=>r.name.common).sort()),U(1)).subscribe(e=>{this.countries=e,this.filteredCountries=this.userForm.get("country").valueChanges.pipe(N(""),C(r=>this._filterCountries(r||"")))})}catch(e){console.error("\u274C Error al cargar pa\xEDses:",e)}})}loadRoles(){return p(this,null,function*(){try{this.roles=yield this._userAdminService.getRoleTypes()}catch(e){console.error("\u274C Error al cargar roles:",e)}})}_filterCountries(e){let r=e.toLowerCase();return this.countries.filter(l=>l.toLowerCase().includes(r))}saveUser(){return p(this,null,function*(){if(this.userForm.invalid){this.userForm.markAllAsTouched(),this._notificationsService.error("Por favor completa todos los campos requeridos.");return}this.loading=!0;try{this.isEditMode?yield this.updateUser():yield this.createUser()}catch(e){console.error("\u274C Error al guardar usuario:",e),this._notificationsService.error(e.message||"Error al guardar el usuario.")}finally{this.loading=!1}})}createUser(){return p(this,null,function*(){let e=this.userForm.value,r=this._ramdomPassword.generateRandomPassword(),{data:l}=yield this._supabaseClient.from("profile").select("id").eq("email",e.email).maybeSingle();if(l)throw new Error("Este correo ya est\xE1 registrado.");let{data:m,error:E}=yield this._supabaseClient.auth.signUp({email:e.email,password:r,options:{emailRedirectTo:`${window.location.origin}/auth/callback`,data:{fullName:e.fullName,username:e.username,country:e.country,phone:e.phone}}});if(E)throw E;if(!m.user)throw new Error("No se pudo crear el usuario.");let{error:y}=yield this._supabaseClient.from("profile").insert({id:m.user.id,email:m.user.email,fullName:e.fullName,username:e.username,country:e.country,phone:e.phone,roleTypeId:e.roleTypeId,bibliography:e.bibliography||"",created_at:new Date().toISOString()});if(y)throw new Error("Error al crear el perfil: "+y.message);let{error:v}=yield this._supabaseClient.auth.resetPasswordForEmail(e.email,{redirectTo:`${window.location.origin}/auth/set-password`});v?(console.error("\u274C Error al enviar correo de contrase\xF1a:",v),this._notificationsService.warning('Usuario creado, pero no se pudo enviar el correo. Usa "Restablecer contrase\xF1a" desde el login.')):this._notificationsService.success(`Correo enviado a ${e.email} para cambiar su contrase\xF1a`),this._router.navigate(["/organizational/see-users"])})}updateUser(){return p(this,null,function*(){if(!this.userId)return;let e=this.userForm.value;try{let{error:r}=yield this._supabaseClient.from("profile").update({fullName:e.fullName,username:e.username,email:e.email,phone:e.phone,country:e.country,roleTypeId:e.roleTypeId,bibliography:e.bibliography}).eq("id",this.userId);if(r)throw r;this._notificationsService.success("Usuario actualizado exitosamente."),this._router.navigate(["/organizational/see-users"])}catch(r){throw console.error("\u274C Error al actualizar usuario:",r),new Error(r.message||"Error al actualizar el usuario.")}})}cancel(){this._router.navigate(["/organizational/see-users"])}static \u0275fac=function(r){return new(r||o)};static \u0275cmp=k({type:o,selectors:[["app-edit-user-panel"]],decls:13,vars:3,consts:[["autoCountry","matAutocomplete"],[1,"brand-content-center","py-10","md:py-10"],[1,"border-[0.5px]","border-[#757575]","p-5","md:p-5","lg:p-10","rounded-lg","bg-[#F0F4F9]","text-black","w-[90%]","md:w-[90%]","lg:w-[90%]","2xl:w-[90%]","3xl:w-[80%]"],[1,"mb-6"],[1,"flex","items-center","gap-2","mb-0","md:mb-2"],["mat-icon-button","","routerLink","/organizational/see-users",1,"!text-gray-700"],[1,"text-lg","md:text-2xl","font-bold","text-gray-800"],[1,"text-xs","md:text-base","text-gray-600","ml-12"],[1,"flex","justify-center","items-center","pb-20","md:pb-10"],[1,"space-y-6",3,"formGroup"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-6"],["appearance","outline",1,"w-full"],["matInput","","formControlName","fullName","placeholder","Ej: Juan P\xE9rez"],["matPrefix",""],["matInput","","formControlName","username","placeholder","Ej: juanperez"],["matInput","","formControlName","email","type","email","placeholder","Ej: juan@ejemplo.com"],["matInput","","formControlName","phone","placeholder","Ej: +57 300 123 4567"],["matInput","","formControlName","country","placeholder","Buscar pa\xEDs...",3,"matAutocomplete"],[3,"value"],["formControlName","roleTypeId"],[1,"bg-blue-50","border","border-violet-200","rounded-lg","p-4"],[1,"flex","gap-4","justify-end","pt-0","md:pt-4"],["type","button","mat-stroked-button","",1,"!border-gray-400","!text-gray-700","hover:!bg-gray-50",3,"click","disabled"],["mat-raised-button","","color","primary",1,"",3,"click","disabled"],[1,"mr-1"],["matInput","","formControlName","bibliography","rows","4","placeholder","Informaci\xF3n adicional sobre el usuario..."],[1,"flex-col","md:flex-row","items-start","gap-3"],[1,"text-violet-600","mt-0.5"],[1,"font-semibold","text-violet-800"],[1,"text-sm","text-violet-700"]],template:function(r,l){r&1&&(i(0,"div",1)(1,"section",2)(2,"div",3)(3,"div",4)(4,"button",5)(5,"mat-icon"),a(6,"arrow_back"),t()(),i(7,"span",6),a(8),t()(),i(9,"p",7),a(10),t()(),u(11,Fe,2,0,"div",8)(12,ze,60,16,"form",9),t()()),r&2&&(n(8),g(" ",l.isEditMode?"Editar Usuario":"Crear Usuario"," "),n(2),g(" ",l.isEditMode?"Modifica los datos del usuario":"Completa los datos para crear un nuevo usuario"," "),n(),c(l.loading?11:12))},dependencies:[G,de,ne,ie,oe,ae,le,se,he,fe,ue,ce,pe,ge,_e,xe,be,W,X,Q,K,te,ve,Ee,ye,J,H,Z,re,B],encapsulation:2})};export{Se as EditUserPanel};
