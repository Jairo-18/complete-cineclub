import './polyfills.server.mjs';
import{a as Qe}from"./chunk-42SZ4UZY.mjs";import{a as fe}from"./chunk-WIA4AUCB.mjs";import{b as ze,c as Ae}from"./chunk-XY6M35EK.mjs";import{a as ee,b as Oe}from"./chunk-ZI5IGZAG.mjs";import"./chunk-VRKUPS3B.mjs";import{a as Ue,b as Le}from"./chunk-GZ6OCTNW.mjs";import"./chunk-LJDVZHPD.mjs";import{a as Ne,b as ue}from"./chunk-7ZPJTXPL.mjs";import{a as J,b as K,c as X,d as Z}from"./chunk-VX5I47V5.mjs";import{a as De}from"./chunk-TCU7CGXP.mjs";import"./chunk-XXL64ETW.mjs";import"./chunk-CPUCP4NP.mjs";import"./chunk-HOIKXKDC.mjs";import{g as Be,h as je}from"./chunk-JGNX5KPE.mjs";import{a as Re,d as pe,e as Ve}from"./chunk-LYFFEPC2.mjs";import"./chunk-ZR6RAYMG.mjs";import"./chunk-GRXIXLG2.mjs";import"./chunk-SN4ZLEXK.mjs";import"./chunk-C7WF65TO.mjs";import{a as Y}from"./chunk-KXZRHGC3.mjs";import{a as $,b as G}from"./chunk-IZYF7JLB.mjs";import"./chunk-POLO5U2S.mjs";import{b as de,c as me}from"./chunk-DMVK7NGP.mjs";import{A as le,D as se,E as ce,e as te,j as ie,n as ne,u as oe,w as re,z as ae}from"./chunk-R2LPZPTP.mjs";import{l as R,m as Fe,n as ke,o as V}from"./chunk-37XX4R2Q.mjs";import{b as y,c as S}from"./chunk-QHGSIMU3.mjs";import"./chunk-3YY5WZBW.mjs";import{l as q}from"./chunk-6XZJ4HF4.mjs";import"./chunk-BKMGEJ4V.mjs";import"./chunk-ABBCMJJI.mjs";import{f as Pe}from"./chunk-5Y2PL6TA.mjs";import{a as H}from"./chunk-TPI6FTCS.mjs";import{$b as O,Db as v,Gb as u,Ha as P,Ib as c,La as d,Mb as ye,Nb as Me,Ob as Se,Wb as s,Xa as w,Xb as I,Yb as h,Zc as W,_ as x,_b as j,_c as M,ab as F,ac as z,bc as Ee,da as m,ea as p,ec as Ie,ic as A,kc as Q,na as E,nb as f,ob as g,rb as k,rc as Te,sb as D,tb as b,ub as r,vb as a,wb as _}from"./chunk-I37AKPGM.mjs";import"./chunk-BPPYXBGU.mjs";import{a as T,b as be,h as L}from"./chunk-S6KH3LOX.mjs";function $e(i,t){i&1&&(r(0,"div",0),_(1,"app-loader"),a())}function Ge(i,t){if(i&1){let e=v();r(0,"input",19),u("input",function(o){m(e);let l=c(2);return p(l.tempValue.set(o.target.value))})("keyup.enter",function(){m(e);let o=c(2);return p(o.saveField("fullName"))})("keyup.escape",function(){m(e);let o=c(2);return p(o.cancelEditing())}),a()}if(i&2){let e=c(2);b("value",e.tempValue())}}function Ye(i,t){if(i&1&&(r(0,"span",6),s(1),a()),i&2){let e,n=c(2);d(),h(" ",((e=n.profile())==null?null:e.fullName)||"Tu nombre completo"," ")}}function Je(i,t){if(i&1){let e=v();r(0,"input",20),u("input",function(o){m(e);let l=c(2);return p(l.tempValue.set(o.target.value))})("keyup.enter",function(){m(e);let o=c(2);return p(o.saveField("username"))})("keyup.escape",function(){m(e);let o=c(2);return p(o.cancelEditing())}),a()}if(i&2){let e=c(2);b("value",e.tempValue())}}function Ke(i,t){if(i&1&&(r(0,"span",10),s(1),a()),i&2){let e,n=c(2);d(),h(" ",(e=n.profile())!=null&&e.username?"@"+n.profile().username:"nombre_usuario"," ")}}function Xe(i,t){if(i&1){let e=v();r(0,"div",12)(1,"textarea",21),u("input",function(o){m(e);let l=c(2);return p(l.tempValue.set(o.target.value))})("keyup.escape",function(){m(e);let o=c(2);return p(o.cancelEditing())}),a(),r(2,"span",22),s(3),a()()}if(i&2){let e=c(2);d(),b("value",e.tempValue()),d(2),h(" ",e.tempValue().length,"/1500 caracteres ")}}function Ze(i,t){if(i&1){let e=v();r(0,"button",25),u("click",function(){m(e);let o=c(3);return p(o.toggleBibliography())}),s(1),a()}if(i&2){let e=c(3);d(),h(" ",e.showFullBibliography()?"Ver menos":"Ver m\xE1s..."," ")}}function et(i,t){if(i&1&&(r(0,"span",23),s(1),a(),f(2,Ze,2,1,"button",24)),i&2){let e,n=c(2);d(),h(" ",n.displayedBibliography()||"Escribe tu bibliograf\xEDa aqu\xED"," "),d(),g((((e=n.profile())==null||e.bibliography==null?null:e.bibliography.length)??0)>500?2:-1)}}function tt(i,t){if(i&1){let e=v();r(0,"div",1)(1,"img",3),u("error",function(o){m(e);let l=c();return p(l.onImageError(o))}),a(),r(2,"div",4),f(3,Ge,1,1,"input",5)(4,Ye,2,1,"span",6),r(5,"button",7)(6,"mat-icon",8),u("click",function(){m(e);let o=c();return p(o.editingField()==="fullName"?o.saveField("fullName"):o.startEditing("fullName"))}),s(7),a()()(),r(8,"div",4),f(9,Je,1,1,"input",9)(10,Ke,2,1,"span",10),r(11,"button",7)(12,"mat-icon",8),u("click",function(){m(e);let o=c();return p(o.editingField()==="username"?o.saveField("username"):o.startEditing("username"))}),s(13),a()()(),r(14,"div",11),f(15,Xe,4,2,"div",12)(16,et,3,2),r(17,"button",13)(18,"mat-icon",8),u("click",function(){m(e);let o=c();return p(o.editingField()==="bibliography"?o.saveField("bibliography"):o.startEditing("bibliography"))}),s(19),a()()(),r(20,"div",14)(21,"div",15)(22,"mat-icon",16),s(23,"public"),a(),r(24,"span",17),s(25),a()(),r(26,"div",15)(27,"mat-icon",16),s(28,"calendar_today"),a(),r(29,"span",18),s(30),A(31,"date"),a()()()()}if(i&2){let e=c();d(),b("src",e.avatarUrl(),P),d(2),g(e.editingField()==="fullName"?3:4),d(4),h(" ",e.editingField()==="fullName"?"save":"edit"," "),d(2),g(e.editingField()==="username"?9:10),d(4),h(" ",e.editingField()==="username"?"save":"edit"," "),d(2),g(e.editingField()==="bibliography"?15:16),d(4),h(" ",e.editingField()==="bibliography"?"save":"edit"," "),d(6),h(" ",e.profile().country||"Pon tu pa\xEDs"," "),d(5),h(" ",Q(31,9,e.profile().created_at,"MMMM, yyyy")," ")}}function it(i,t){if(i&1&&(r(0,"p",28),s(1),a()),i&2){let e=c(2);d(),I(e.errorMessage())}}function nt(i,t){if(i&1){let e=v();r(0,"div",2)(1,"mat-icon",26),s(2,"error_outline"),a(),r(3,"p",27),s(4,"No se pudo cargar el perfil"),a(),f(5,it,2,1,"p",28),r(6,"button",29),u("click",function(){m(e);let o=c();return p(o.loadProfile())}),s(7," Reintentar "),a()()}if(i&2){let e=c();d(5),g(e.errorMessage()?5:-1)}}var ge=class i{profile=E(null);avatarUrl=E("/assets/images/defaultUser.png");loading=E(!0);errorMessage=E(null);editingField=E(null);tempValue=E("");showFullBibliography=E(!1);_profileService=x(fe);_supabaseClient=x(H);ngOnInit(){this.loadProfile()}displayedBibliography=Te(()=>{let t=this.profile()?.bibliography??"";return t.length<=500||this.showFullBibliography()?t:t.slice(0,500)+"..."});toggleBibliography(){this.showFullBibliography.update(t=>!t)}loadProfile(){return L(this,null,function*(){try{this.loading.set(!0);let{data:{session:t}}=yield this._supabaseClient.auth.getSession();if(!t)throw new Error("No hay una sesi\xF3n activa. Por favor, inicia sesi\xF3n nuevamente.");let e=t.user.id,n=t.user.user_metadata?.avatar_url||t.user.user_metadata?.picture||t.user.identities?.[0]?.identity_data?.avatar_url||t.user.identities?.[0]?.identity_data?.picture,{data:o,error:l}=yield this._supabaseClient.from("profile").select("*").eq("id",e).maybeSingle();if(l)throw l;if(!o)throw new Error("No se encontr\xF3 el perfil.");this.profile.set(o);let C=o.avatarUrl;C?this.avatarUrl.set(C):n&&this.avatarUrl.set(n)}catch(t){console.error("\u274C Error cargando perfil:",t),this.errorMessage.set(t instanceof Error?t.message:"Error desconocido al cargar el perfil.")}finally{this.loading.set(!1)}})}startEditing(t){let e=this.profile();if(!e)return;let n=String(e[t]??"");this.tempValue.set(n),this.editingField.set(t)}saveField(t){return L(this,null,function*(){let e=this.profile()?.id;if(!e)return;let n=this.tempValue().trim();if(n.length>1500){this.errorMessage.set("La bibliograf\xEDa no puede superar los 1500 caracteres.");return}let o={[t]:n};try{let l=yield this._profileService.updateProfile(e,o);this.profile.set(l),this.editingField.set(null),this.errorMessage.set(null)}catch(l){this.errorMessage.set(`Error al actualizar: ${l instanceof Error?l.message:"Error desconocido"}`)}})}cancelEditing(){this.editingField.set(null),this.tempValue.set("")}onImageError(t){let e=t.target;e.src="/assets/images/defaultUser.png"}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=w({type:i,selectors:[["app-card-info-user"]],decls:3,vars:3,consts:[[1,"flex","justify-center","items-center","bg-[#F0F4F9]","rounded-lg","shadow-lg","border-[0.5px]","border-[#757575]","pb-32","pt-20"],[1,"flex","flex-col","gap-1","md:gap-5","p-4","md:p-8","bg-[#F0F4F9]","rounded-lg","shadow-lg","border-[0.5px]","border-[#757575]","text-center","justify-center","items-center","text-black"],[1,"flex","flex-col","items-center","justify-center","py-8"],["alt","Imagen de perf\xEDl","referrerpolicy","no-referrer","crossorigin","anonymous",1,"w-[110px]","h-[110px]","rounded-full","object-cover","border-2","border-[#9811fb]/20",3,"error","src"],[1,"flex","flex-col","items-center","justify-center","gap-1","max-w-full","px-2"],["type","text","placeholder","Tu nombre completo",1,"border-b","border-gray-400","outline-none","bg-transparent","max-w-[200px]","sm:max-w-[280px]","md:max-w-none","p-1","focus:border-[#9811fb]","transition","text-center",3,"value"],[1,"text-base","md:text-2xl","lg:text-xl","2xl:text-2xl","font-bold","text-black"],[1,"cursor-pointer","text-[#9811fb]","hover:bg-[#9811fb]","hover:text-white","rounded-full","transition","items-center","justify-center","flex","p-1","flex-shrink-0"],[3,"click"],["type","text","placeholder","@nombre_usuario",1,"border-b","border-gray-400","outline-none","bg-transparent","max-w-[180px]","sm:max-w-[250px]","md:max-w-none","p-1","focus:border-[#9811fb]","transition","text-center",3,"value"],[1,"text-xs","md:text-base","text-[#757575]","font-normal"],[1,"flex","flex-col","items-center","gap-3","mb-2","md:mb-0","max-w-full","px-4"],[1,"w-full","flex","flex-col","items-center","gap-2"],[1,"cursor-pointer","text-[#9811fb]","hover:bg-[#9811fb]","hover:text-white","rounded-full","trasition","items-center","justify-center","flex","p-1","flex-shrink-0"],[1,"flex","content-between","items-center","justify-center","gap-4"],[1,"flex","items-center","gap-3"],[1,"!text-[#9811fb]"],[1,"text-xs","font-normal","text-[#757575]"],[1,"text-xs","font-normal","text-[#757575]","capitalize"],["type","text","placeholder","Tu nombre completo",1,"border-b","border-gray-400","outline-none","bg-transparent","max-w-[200px]","sm:max-w-[280px]","md:max-w-none","p-1","focus:border-[#9811fb]","transition","text-center",3,"input","keyup.enter","keyup.escape","value"],["type","text","placeholder","@nombre_usuario",1,"border-b","border-gray-400","outline-none","bg-transparent","max-w-[180px]","sm:max-w-[250px]","md:max-w-none","p-1","focus:border-[#9811fb]","transition","text-center",3,"input","keyup.enter","keyup.escape","value"],["rows","10","maxlength","1500","placeholder","Escribe tu bibliograf\xEDa (m\xE1x. 1500 caracteres)",1,"w-full","max-w-[280px]","sm:max-w-[350px]","md:max-w-[450px]","lg:max-w-[650px]","2xl:max-w-[400px]","3xl:max-w-[510px]","border","border-gray-300","rounded-md","p-2","resize-none","outline-none","focus:border-[#9811fb]","transition",3,"input","keyup.escape","value"],[1,"text-xs","text-gray-500","self-end","pr-2"],[1,"text-sm","md:text-base","font-medium","text-[#757575]","text-center","max-w-[280px]","sm:max-w-[350px]","md:max-w-[450px]","lg:max-w-[650px]","2xl:max-w-[400px]"],[1,"text-[#9811fb]","text-xs","font-semibold","hover:underline"],[1,"text-[#9811fb]","text-xs","font-semibold","hover:underline",3,"click"],[1,"!text-red-500","!text-5xl"],[1,"text-gray-600","mt-4"],[1,"text-sm","text-red-500","mt-2"],[1,"mt-4","px-4","py-2","bg-[#9811fb]","text-white","rounded-lg","hover:bg-[#7a0dd1]","transition",3,"click"]],template:function(e,n){e&1&&(f(0,$e,2,0,"div",0),f(1,tt,32,12,"div",1),f(2,nt,8,1,"div",2)),e&2&&(g(n.loading()?0:-1),d(),g(!n.loading()&&n.profile()?1:-1),d(),g(!n.loading()&&!n.profile()?2:-1))},dependencies:[S,y,M,Y,W],encapsulation:2})};var rt=["scrollContainer"],at=(i,t)=>t.id;function lt(i,t){i&1&&(r(0,"div",3),_(1,"mat-spinner",7),a())}function st(i,t){i&1&&(r(0,"p",4),s(1,"No tienes amigos agregados a\xFAn."),a())}function ct(i,t){if(i&1){let e=v();r(0,"div",8)(1,"div",10)(2,"img",11),u("error",function(o){m(e);let l=c(2);return p(l.onImageError(o))}),a(),r(3,"div",12)(4,"span",13),s(5),a(),r(6,"span",14),s(7),a()()(),r(8,"button",15),u("click",function(){let o=m(e).$implicit,l=c(2);return p(l.shareWithFriend(o.friend.id))}),r(9,"mat-icon"),s(10,"send"),a()()()}if(i&2){let e=t.$implicit,n=c(2);d(2),b("src",e.friend.avatarUrl||"/assets/images/defaultUser.png",P),d(3),I(e.friend.fullName),d(2),I(e.friend.email),d(),b("disabled",n.sharing)}}function dt(i,t){i&1&&(r(0,"div",9),_(1,"mat-spinner",16),a())}function mt(i,t){if(i&1&&(k(0,ct,11,4,"div",8,at),f(2,dt,2,0,"div",9)),i&2){let e=c();D(e.friends),d(2),g(e.isLoadingMore?2:-1)}}var xe=class i{scrollContainer;_friendRequestService=x(De);_profileService=x(fe);_notificationsService=x(q);_dialogRef=x(Re);_supabaseClient=x(H);friends=[];loading=!1;isLoadingMore=!1;sharing=!1;currentPage=1;totalPages=0;hasNext=!1;scrollListener=null;ngOnInit(){this.loadFriends()}ngAfterViewInit(){this.setupScrollListener()}ngOnDestroy(){this.scrollListener&&this.scrollContainer&&this.scrollContainer.nativeElement.removeEventListener("scroll",this.scrollListener)}setupScrollListener(){this.scrollContainer&&(this.scrollListener=()=>{this.checkScroll(this.scrollContainer.nativeElement)},this.scrollContainer.nativeElement.addEventListener("scroll",this.scrollListener))}checkScroll(t){let e=t.scrollTop+t.clientHeight,n=t.scrollHeight,l=e/n*100>=90,C=n<=t.clientHeight;(l||C)&&this.hasNext&&!this.isLoadingMore&&!this.loading&&this.loadMore()}loadFriends(){this.loading||(this.loading=!0,this._friendRequestService.getFriends({page:this.currentPage,size:5}).subscribe({next:t=>L(this,null,function*(){let e=t.data||[],n=e.map(C=>C.friend.id),o={};if(n.length>0){let{data:C}=yield this._supabaseClient.from("profile").select("id, avatarUrl").in("id",n);C&&C.forEach(B=>{o[B.id]=B})}let l=e.map(C=>{let B=o[C.friend.id];return be(T({},C),{friend:be(T({},C.friend),{avatarUrl:B?.avatarUrl||"/assets/images/defaultUser.png"})})});this.currentPage===1?this.friends=l:this.friends=[...this.friends,...l],this.totalPages=t.totalPages,this.hasNext=t.hasNext,this.loading=!1,this.isLoadingMore=!1,setTimeout(()=>{this.scrollContainer&&this.checkScroll(this.scrollContainer.nativeElement)})}),error:t=>{console.error("Error loading friends:",t),this.loading=!1,this.isLoadingMore=!1}}))}loadMore(){this.hasNext&&!this.isLoadingMore&&(this.isLoadingMore=!0,this.currentPage++,this.loadFriends())}shareWithFriend(t){this.sharing=!0,this._profileService.shareCollection(t).subscribe({next:()=>{this.sharing=!1,this._dialogRef.close()},error:()=>{this._notificationsService.error("Ya has enviado una solicitud a este usuario."),this.sharing=!1}})}close(){this._dialogRef.close()}onImageError(t){let e=t.target;e.src="/assets/images/defaultUser.png"}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=w({type:i,selectors:[["app-shared-collection-dialog"]],viewQuery:function(e,n){if(e&1&&ye(rt,5),e&2){let o;Me(o=Se())&&(n.scrollContainer=o.first)}},decls:10,vars:3,consts:[["scrollContainer",""],[3,"title","description"],["form","",1,"flex","flex-col","gap-3","overflow-y-auto","custom-scrollbar","max-h-[350px]","pr-2","md:pr-4"],[1,"flex","justify-center","py-8"],[1,"text-center","text-gray-500","py-8"],["actions","",1,"w-full"],["mat-raised-button","","color","warn",1,"w-full","!bg-red-600","!text-white",3,"click"],["diameter","30"],[1,"flex","items-center","justify-between","p-3","shadow-lg","border-[0.5px]","border-[#757575]","rounded-lg","transition-colors"],[1,"flex","justify-center","py-4"],[1,"flex","items-center","gap-3"],["alt","Avatar","referrerpolicy","no-referrer","crossorigin","anonymous",1,"w-10","h-10","rounded-full","object-cover","shadow-xl","border-[0.5px]","border-[#757575]",3,"error","src"],[1,"flex","flex-col"],[1,"font-semibold","text-gray-800"],[1,"text-xs","text-gray-500"],["mat-icon-button","","color","primary","matTooltip","Compartir",3,"click","disabled"],["diameter","20"]],template:function(e,n){if(e&1){let o=v();r(0,"app-base-dialog",1)(1,"div",2,0),f(3,lt,2,0,"div",3)(4,st,2,0,"p",4)(5,mt,3,1),a(),r(6,"div",5)(7,"button",6),u("click",function(){return m(o),p(n.close())}),r(8,"span"),s(9,"Cerrar"),a()()()()}e&2&&(b("title","Compartir Biblioteca")("description","Comparte tu colecci\xF3n de pel\xEDculas con un amigo"),d(3),g(n.loading&&n.currentPage===1?3:n.friends.length===0?4:5))},dependencies:[M,Ve,V,Fe,R,S,y,G,$,je,Be,Ne],styles:[".custom-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px}.custom-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#f1f1f1;border-radius:4px}.custom-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:4px}.custom-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover{background:#a8a8a8}"]})};var ft=()=>[2,4,10,25],gt=(i,t)=>t.id;function _t(i,t){i&1&&(r(0,"div",0),_(1,"app-loader"),a())}function xt(i,t){if(i&1&&s(0),i&2){let e=c(2);h(' No se encontraron pel\xEDculas con "',e.searchTerm,'" ')}}function vt(i,t){i&1&&s(0," No tienes pel\xEDculas guardadas. ")}function ht(i,t){if(i&1&&(r(0,"div",0)(1,"p",2),f(2,xt,1,1)(3,vt,1,0),a()()),i&2){let e=c();d(2),g(e.searchTerm?2:3)}}function Ct(i,t){if(i&1){let e=v();r(0,"button",13),u("click",function(){m(e);let o=c(2);return p(o.clearSearch())}),r(1,"mat-icon"),s(2,"close"),a()()}}function wt(i,t){if(i&1){let e=v();r(0,"div",11)(1,"div",14)(2,"button",15),u("click",function(){let o=m(e).$implicit,l=c(2);return p(l.openDeleteMovieDialog(o.id))}),r(3,"mat-icon"),s(4,"delete"),a()()(),r(5,"div",16)(6,"div",17)(7,"img",18),u("error",function(o){m(e);let l=c(2);return p(l.onImageError(o))}),a()(),r(8,"div",19)(9,"h3",20),s(10),a(),r(11,"p",21),s(12),a(),r(13,"p",22)(14,"span",23),s(15,"Fecha de estreno:"),a(),s(16),A(17,"date"),a()()()()}if(i&2){let e=t.$implicit,n=c(2);d(7),b("alt",Ee(e.title))("src",n.getMoviePoster(e.posterPath),P),d(3),I(e.title),d(2),h(" ",e.overview||"Sin descripci\xF3n disponible."," "),d(4),h(" ",Q(17,6,e.releaseDate,"yyyy-MM-dd")," ")}}function bt(i,t){if(i&1){let e=v();r(0,"article",1)(1,"div",3)(2,"mat-form-field",4)(3,"mat-label"),s(4,"Buscar en mis pel\xEDculas"),a(),r(5,"input",5),z("ngModelChange",function(o){m(e);let l=c();return O(l.searchTerm,o)||(l.searchTerm=o),p(o)}),u("ngModelChange",function(){m(e);let o=c();return p(o.onSearchChange())}),a(),r(6,"mat-icon",6),s(7,"search"),a(),f(8,Ct,3,0,"button",7),a(),r(9,"div",8)(10,"button",9),u("click",function(){m(e);let o=c();return p(o.openShareDialog())}),s(11," Compartir biblioteca "),a()()(),r(12,"div",10),k(13,wt,18,9,"div",11,gt),a(),r(15,"mat-paginator",12),u("page",function(o){m(e);let l=c();return p(l.onChangePagination(o))}),a()()}if(i&2){let e=c();d(5),j("ngModel",e.searchTerm),d(3),g(e.searchTerm?8:-1),d(5),D(e.movies),d(2),b("length",e.paginationParams.total)("pageSize",e.paginationParams.size)("pageSizeOptions",Ie(6,ft))("pageIndex",(e.paginationParams.page||0)-1)}}var ve=class i{movies=[];allMovies=[];loading=!1;searchTerm="";searchTimeout;paginationParams={page:1,size:2,total:0,totalPages:0,hasNext:!1,hasPrevious:!1};_collectionsService=x(Qe);_dialog=x(pe);_notificationsService=x(q);ngOnInit(){this.loadSavedMovies()}loadSavedMovies(){this.loading=!0,this._collectionsService.getSavedMovies({page:1,size:100}).subscribe({next:t=>{this.allMovies=t.data.flatMap(e=>e.movies)||[],this.applyFilterAndPagination(),this.loading=!1},error:()=>{this.loading=!1}})}applyFilterAndPagination(){let t=this.allMovies;if(this.searchTerm&&this.searchTerm.trim()){let o=this.searchTerm.toLowerCase().trim();t=this.allMovies.filter(l=>l.title?.toLowerCase().includes(o))}this.paginationParams.total=t.length,this.paginationParams.totalPages=Math.ceil(this.paginationParams.total/this.paginationParams.size);let e=(this.paginationParams.page-1)*this.paginationParams.size,n=e+this.paginationParams.size;this.movies=t.slice(e,n)}onChangePagination(t){this.paginationParams.page=t.pageIndex+1,this.paginationParams.size=t.pageSize,this.applyFilterAndPagination()}onSearchChange(){this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>{this.paginationParams.page=1,this.applyFilterAndPagination()},500)}clearSearch(){this.searchTerm="",this.paginationParams.page=1,this.applyFilterAndPagination()}openDeleteMovieDialog(t){this._dialog.open(ue,{data:{title:"\xBFEliminar pel\xEDcula?",message:"Esta acci\xF3n no se puede deshacer."}}).afterClosed().subscribe(n=>{n&&this.removeMovie(t)})}removeMovie(t){this.loading=!0,this._collectionsService.removeMovieFromCollection(t).subscribe({next:()=>{this.loadSavedMovies()},error:e=>{console.error(e),this._notificationsService.error("No se pudo eliminar"),this.loading=!1}})}getMoviePoster(t){let e="assets/images/default-movie.png",n="https://image.tmdb.org/t/p/w500";return!t||t.trim()===""||t==="null"||t==="undefined"?e:`${n}${t}`}openShareDialog(){this._dialog.open(xe,{width:"600px",maxWidth:"90vw"})}onImageError(t){let e=t.target;e.src="assets/images/default-movie.png"}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=w({type:i,selectors:[["app-movies-content"]],decls:3,vars:1,consts:[[1,"flex","justify-center","items-center","bg-[#F0F4F9]","pb-32","pt-20"],[1,"p-4","md:p-8","text-center","text-black"],[1,"text-gray-600","mt-8","text-lg"],[1,"flex","flex-col","md:flex-row","gap-0","md:gap-4","mb-6","md:mb-0"],["appearance","outline",1,"w-full","md:w-[70%]"],["matInput","","type","text","placeholder","Buscar por t\xEDtulo...",3,"ngModelChange","ngModel"],["matPrefix",""],["matSuffix","","mat-icon-button",""],[1,"w-full","md:w-[30%]","h-[56px]"],["mat-fab","","extended","",1,"!w-full","!h-[56px]",3,"click"],[1,"flex","flex-col","gap-6"],[1,"flex","flex-col","w-full","bg-white","rounded-xl","p-6","justify-center","items-start","gap-4","hover:shadow-lg","hover:scale-[1.01]","transition-all","duration-300","shadow-lg","border-[0.5px]","border-[#757575]","relative"],[1,"mt-6","rounded-lg",3,"page","length","pageSize","pageSizeOptions","pageIndex"],["matSuffix","","mat-icon-button","",3,"click"],[1,"flex","w-full","justify-end","items-center"],[1,"text-red-600","hover:bg-red-600","hover:text-white","transition-colors","rounded-full","px-2","py-1",3,"click"],[1,"w-full","flex","flex-col","md:flex-row","justify-start","items-start","gap-3"],[1,"flex","w-full","md:w-[150px]","h-[210px]","md:h-[210px]","justify-center","items-center"],[1,"w-[150px]","md:w-[150px]","h-[210px]","md:h-[210px]","object-cover","flex-shrink-0","rounded-lg","shadow-xl","border-[0.5px]","border-[#757575]",3,"error","src","alt"],[1,"flex","flex-col","gap-2","justify-center","items-start","text-left"],[1,"text-xl","font-semibold","mb-1"],[1,"text-gray-700","text-sm","mb-3","line-clamp-3"],[1,"text-gray-500","text-xs","mb-3"],[1,"font-medium"]],template:function(e,n){e&1&&f(0,_t,2,0,"div",0)(1,ht,4,1,"div",0)(2,bt,16,7,"article",1),e&2&&g(n.loading?0:n.movies.length===0?1:2)},dependencies:[M,y,Y,oe,te,ie,ne,Ae,ze,me,de,se,re,ae,le,ce,V,R,ke,W],encapsulation:2})};function Mt(i,t){i&1&&(r(0,"mat-icon",2),s(1,"local_movies"),a(),s(2," Tus pel\xEDculas guardadas "))}function St(i,t){i&1&&(r(0,"mat-icon",2),s(1,"book"),a(),s(2," Tus libros guardadas "))}var he=class i{static \u0275fac=function(e){return new(e||i)};static \u0275cmp=w({type:i,selectors:[["app-card-tabs"]],decls:8,vars:0,consts:[[1,"bg-[#F0F4F9]","rounded-lg","shadow-lg","border-[0.5px]","border-[#757575]"],["mat-tab-label",""],[1,"mr-1"]],template:function(e,n){e&1&&(r(0,"article",0)(1,"mat-tab-group")(2,"mat-tab"),F(3,Mt,3,0,"ng-template",1),_(4,"app-movies-content"),a(),r(5,"mat-tab"),F(6,St,3,0,"ng-template",1),_(7,"app-books-content"),a()()())},dependencies:[S,y,Z,J,K,X,ve,ee],encapsulation:2})};var Et=(i,t)=>t.id;function It(i,t){if(i&1){let e=v();r(0,"button",6),u("click",function(){m(e);let o=c();return o.searchQuery="",p(o.onSearchChange())}),r(1,"mat-icon"),s(2,"close"),a()()}}function Tt(i,t){i&1&&(r(0,"div",5),_(1,"mat-spinner",7),a())}function Pt(i,t){if(i&1){let e=v();r(0,"app-card-review",12),u("editReview",function(o){m(e);let l=c(2);return p(l.onEditReview(o))})("deleteReview",function(o){m(e);let l=c(2);return p(l.onDeleteReview(o))})("goToReview",function(o){m(e);let l=c(2);return p(l.onGoToReview(o))}),a()}if(i&2){let e=t.$implicit,n=c(2);b("id",e.id)("title",e.title)("content",e.content)("posterPath",e.posterPath)("reviewerName",e.reviewerName)("directorName",e.directorName)("rating",e.rating)("createdAt",e.createdAt)("userId",e.userId)("currentUserId",n.currentUserId)("showImage",!0)("showGoToReview",!0)("likes",e.likes)("comments",e.comments)("liked",e.liked)}}function Ft(i,t){i&1&&(r(0,"div",10)(1,"mat-icon",13),s(2,"rate_review"),a(),r(3,"p",14),s(4,"No has escrito ninguna rese\xF1a a\xFAn"),a()())}function kt(i,t){if(i&1&&(r(0,"div",10)(1,"mat-icon",13),s(2,"search_off"),a(),r(3,"p",14),s(4),a()()),i&2){let e=c(2);d(4),h('No se encontraron rese\xF1as con el t\xEDtulo "',e.searchQuery,'"')}}function Dt(i,t){i&1&&(r(0,"div",11),_(1,"mat-spinner",15),a())}function Rt(i,t){if(i&1&&(r(0,"div",8),k(1,Pt,1,15,"app-card-review",9,Et),f(3,Ft,5,0,"div",10),f(4,kt,5,1,"div",10),a(),f(5,Dt,2,0,"div",11)),i&2){let e=c();d(),D(e.filteredReviews),d(2),g(e.filteredReviews.length===0&&!e.searchQuery?3:-1),d(),g(e.filteredReviews.length===0&&e.searchQuery?4:-1),d(),g(e.isLoadingMore?5:-1)}}var Ce=class i{_reviewsService=x(Ue);dialog=x(pe);router=x(Pe);reviewsChangedSubscription;reviews=[];filteredReviews=[];isLoading=!1;isLoadingMore=!1;currentUserId="";searchQuery="";pagination={page:1,size:10,total:0,totalPages:0,hasNext:!1,hasPrevious:!1};ngOnInit(){this.getCurrentUserId(),this.loadReviews(),this.setupScrollListener(),this.reviewsChangedSubscription=this._reviewsService.reviewsChanged$.subscribe(()=>{this.reviews=[],this.filteredReviews=[],this.pagination.page=1,this.isLoadingMore=!1,this.searchQuery="";let t=document.querySelector("main.main");t?t.scrollTop=0:window.scrollTo(0,0),this.loadReviews(!0)})}ngOnDestroy(){this.reviewsChangedSubscription&&this.reviewsChangedSubscription.unsubscribe()}getCurrentUserId(){let t=localStorage.getItem("app_session");if(t)try{let e=JSON.parse(t);this.currentUserId=e.user?.id||""}catch(e){console.error("Error parsing session:",e)}else console.warn("\u26A0\uFE0F No session found in localStorage")}setupScrollListener(){let t=document.querySelector("main.main");t?t.addEventListener("scroll",()=>{this.checkScroll(t)}):window.addEventListener("scroll",()=>{this.checkScrollWindow()})}checkScroll(t){let e=t.scrollTop+t.clientHeight,n=t.scrollHeight;e/n*100>=50&&this.pagination.hasNext&&!this.isLoadingMore&&this.loadMoreReviews()}checkScrollWindow(){let t=window.pageYOffset+window.innerHeight,e=document.documentElement.scrollHeight;t/e*100>=50&&this.pagination.hasNext&&!this.isLoadingMore&&this.loadMoreReviews()}loadReviews(t=!0){t&&(this.isLoading=!0),setTimeout(()=>{let e={page:this.pagination.page,size:this.pagination.perPage,sort:"created_at,desc"};this._reviewsService.getUserReviewsWithPagination(e).subscribe({next:n=>{this.reviews=n.data.sort((o,l)=>new Date(l.createdAt).getTime()-new Date(o.createdAt).getTime()),this.pagination=T({},n.pagination),this.applySearch(),t&&(this.isLoading=!1)},error:()=>{t&&(this.isLoading=!1)}})})}loadMoreReviews(){if(!this.pagination.hasNext||this.isLoadingMore)return;this.isLoadingMore=!0,this.pagination.page++;let t={page:this.pagination.page,size:this.pagination.perPage,sort:"created_at,desc"};this._reviewsService.getUserReviewsWithPagination(t).subscribe({next:e=>{let n=new Set(this.reviews.map(l=>l.id)),o=e.data.filter(l=>!n.has(l.id));this.reviews=[...this.reviews,...o],this.reviews.sort((l,C)=>new Date(C.createdAt).getTime()-new Date(l.createdAt).getTime()),this.pagination=T({},e.pagination),this.applySearch(),this.isLoadingMore=!1},error:()=>{this.isLoadingMore=!1,this.pagination.page--}})}onSearchChange(){this.applySearch()}applySearch(){if(!this.searchQuery.trim())this.filteredReviews=[...this.reviews];else{let t=this.searchQuery.toLowerCase().trim();this.filteredReviews=this.reviews.filter(e=>e.title.toLowerCase().includes(t))}}onEditReview(t){let e=this.reviews.find(o=>o.id===t);if(!e)return;this.dialog.open(Oe,{width:"600px",maxWidth:"90vw",data:{title:"Editar Rese\xF1a",message:"Modifica tu opini\xF3n sobre esta pel\xEDcula",isEdit:!0,reviewData:{content:e.content,rating:e.rating,movieTitle:e.title}}}).afterClosed().subscribe(o=>{o&&o.content&&o.rating&&this._reviewsService.updateReview(t,o).subscribe({next:()=>{this._reviewsService.notifyReviewsChanged()},error:l=>{console.error("Error actualizando review:",l)}})})}onDeleteReview(t){this.dialog.open(ue,{width:"600px",maxWidth:"90vw",data:{title:"Eliminar Rese\xF1a",message:"\xBFEst\xE1s seguro de que deseas eliminar esta rese\xF1a? Esta acci\xF3n no se puede deshacer."}}).afterClosed().subscribe(n=>{n&&this._reviewsService.deleteReview(t).subscribe({next:()=>{this._reviewsService.notifyReviewsChanged()},error:o=>{console.error("Error eliminando review:",o)}})})}onGoToReview(t){this.router.navigate(["/home"],{queryParams:{reviewId:t}})}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=w({type:i,selectors:[["app-user-reviews"]],decls:10,vars:3,consts:[[1,"container","mx-auto","px-4","py-4","text-black"],["appearance","outline",1,"w-full"],["matInput","","type","text","placeholder","Escribe el t\xEDtulo de la pel\xEDcula...",3,"ngModelChange","ngModel"],["matPrefix",""],["matSuffix","","mat-icon-button","",1,"text-gray-500"],[1,"flex","justify-center","items-center","py-12"],["matSuffix","","mat-icon-button","",1,"text-gray-500",3,"click"],["diameter","50"],[1,"grid","gap-6"],[1,"w-[250px]","md:w-full",3,"id","title","content","posterPath","reviewerName","directorName","rating","createdAt","userId","currentUserId","showImage","showGoToReview","likes","comments","liked"],[1,"text-center","py-12","text-gray-600"],[1,"flex","justify-center","items-center","py-6"],[1,"w-[250px]","md:w-full",3,"editReview","deleteReview","goToReview","id","title","content","posterPath","reviewerName","directorName","rating","createdAt","userId","currentUserId","showImage","showGoToReview","likes","comments","liked"],[1,"text-6xl","mb-4"],[1,"text-xl"],["diameter","40"]],template:function(e,n){e&1&&(r(0,"div",0)(1,"mat-form-field",1)(2,"mat-label"),s(3,"Buscar por t\xEDtulo"),a(),r(4,"input",2),z("ngModelChange",function(l){return O(n.searchQuery,l)||(n.searchQuery=l),l}),u("ngModelChange",function(){return n.onSearchChange()}),a(),r(5,"mat-icon",3),s(6,"search"),a(),f(7,It,3,0,"button",4),a(),f(8,Tt,2,0,"div",5)(9,Rt,6,3),a()),e&2&&(d(4),j("ngModel",n.searchQuery),d(3),g(n.searchQuery?7:-1),d(),g(n.isLoading?8:9))},dependencies:[M,oe,te,ie,ne,Le,V,R,S,y,me,de,se,re,ae,le,ce,G,$],styles:[".mat-mdc-form-field .mat-mdc-text-field-wrapper{background-color:#fff;border-radius:8px}  .mat-mdc-form-field .mat-mdc-form-field-focus-overlay{background-color:transparent}"]})};function Vt(i,t){i&1&&(r(0,"mat-icon",2),s(1,"local_movies"),a(),s(2," Tus rese\xF1as de pel\xEDculas "))}function Ut(i,t){i&1&&(r(0,"mat-icon",2),s(1,"book"),a(),s(2," Tus rese\xF1as de libros "))}var we=class i{static \u0275fac=function(e){return new(e||i)};static \u0275cmp=w({type:i,selectors:[["app-card-tabs-reviews"]],decls:8,vars:0,consts:[[1,"bg-[#F0F4F9]/70","backdrop-blur-sm","rounded-lg","shadow-lg","border-[0.5px]","border-[#757575]"],["mat-tab-label",""],[1,"mr-1"]],template:function(e,n){e&1&&(r(0,"article",0)(1,"mat-tab-group")(2,"mat-tab"),F(3,Vt,3,0,"ng-template",1),_(4,"app-user-reviews"),a(),r(5,"mat-tab"),F(6,Ut,3,0,"ng-template",1),_(7,"app-books-content"),a()()())},dependencies:[S,y,Z,J,K,X,ee,Ce],encapsulation:2})};var qe=class i{static \u0275fac=function(e){return new(e||i)};static \u0275cmp=w({type:i,selectors:[["app-user-profile"]],decls:10,vars:0,consts:[[1,"relative","w-full"],[1,"w-full","h-[400px]","md:h-[600px]","lg:h-[600px]","2xl:h-[400px]","3xl:h-[400px]","border","border-[#7B7B7B]/50","shadow-xl","text-black","bg-fondo","bg-blend-overlay"],[1,"flex","flex-col","gap-6","justify-center","items-center"],[1,"relative","w-[95%]","-mt-80","md:-mt-96","lg:-mt-96","2xl:-mt-[300px]","3xl:-mt-[300px]","z-20","flex","flex-col","md:flex-col","lg:flex-col","2xl:flex-row","3xl:flex-row","justify-center","md:justify-center","items-center","md:items-center","lg:items-center","2xl:items-center","3xl:items-center","gap-6","md:gap-6","lg:gap-6","2xl:gap-6","3xl:gap-6","pb-0"],[1,"w-full","md:w-full","lg:w-[95%]","2xl:w-[40%]","3xl:w-[40%]"],[1,"mt-0","2xl:mt-[30px]","3xl:mt-[40px]","w-full","md:w-full","lg:w-[95%]","2xl:w-[60%]","3xl:w-[60%]"],[1,"relative","w-[95%]","justify-center","mx-auto","mb-20"]],template:function(e,n){e&1&&(r(0,"article",0),_(1,"div",1),a(),r(2,"div",2)(3,"div",3)(4,"section",4),_(5,"app-card-info-user"),a(),r(6,"section",5),_(7,"app-card-tabs"),a()(),r(8,"section",6),_(9,"app-card-tabs-reviews"),a()())},dependencies:[M,ge,he,we],styles:[".bg-fondo[_ngcontent-%COMP%]{background-image:url(/assets/images/optimusprain.jpg);background-size:cover;background-position:center}"]})};export{qe as UserProfile};
