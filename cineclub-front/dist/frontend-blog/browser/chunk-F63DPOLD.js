import{a as S}from"./chunk-HI5P6VLK.js";import{Hc as c,V as a,_ as l,g as t,xa as u}from"./chunk-4XNWJBNU.js";import{i as o}from"./chunk-ODN5LVDJ.js";var f=class i{SESSION_KEY="app_session";platformId=l(u);isBrowser=c(this.platformId);_sessionSubject=new t(this.isBrowser?this.getSession():null);session$=this._sessionSubject.asObservable();_userRoleSubject=new t(this.isBrowser?this.getUserRole():null);userRole$=this._userRoleSubject.asObservable();_isLoggingOut=!1;saveSession(s,e,r){if(!this.isBrowser)return;if(!s||!e||!r){console.warn("\u26A0\uFE0F No se puede guardar sesi\xF3n: faltan datos");return}let n={access_token:s,refresh_token:e,user:r};localStorage.setItem(this.SESSION_KEY,JSON.stringify(n)),this._sessionSubject.next(n),this._userRoleSubject.next(r?.roleType?.code??null)}getSession(){if(!this.isBrowser)return null;let s=localStorage.getItem(this.SESSION_KEY);if(!s)return null;try{let e=JSON.parse(s);return!e.access_token||!e.refresh_token||!e.user?(console.warn("\u26A0\uFE0F Sesi\xF3n inv\xE1lida en localStorage, se eliminar\xE1"),this.clearSession(),null):e}catch(e){return console.error("\u274C Error parseando sesi\xF3n almacenada:",e),this.clearSession(),null}}getAccessToken(){return this.getSession()?.access_token??null}getRefreshToken(){return this.getSession()?.refresh_token??null}getUserData(){return this.getSession()?.user??null}getUserId(){return this.getUserData()?.id??null}getUserRole(){return this.getUserData()?.roleType?.code??null}isLoggedIn(){return!!this.getAccessToken()}clearSession(s=!1){this.isBrowser&&(this._isLoggingOut=s,localStorage.removeItem(this.SESSION_KEY),this._sessionSubject.next(null),this._userRoleSubject.next(null),s&&setTimeout(()=>{this._isLoggingOut=!1},1e3))}isLoggingOut(){return this._isLoggingOut}refreshSession(){return o(this,null,function*(){let s=this.getSession();if(!s?.refresh_token)return console.warn("\u26A0\uFE0F No hay refresh token disponible para refrescar sesi\xF3n"),null;let{data:e,error:r}=yield S.auth.refreshSession({refresh_token:s.refresh_token});if(r)return console.error("\u274C Error al refrescar sesi\xF3n:",r.message),this.clearSession(),null;let n=e?.session;return n?(this.saveSession(n.access_token,n.refresh_token,s.user),this.getSession()):(console.error("\u274C No se recibi\xF3 una nueva sesi\xF3n de Supabase"),null)})}updateUserData(s){if(!this.isBrowser)return;let e=this.getSession();if(!e){console.warn("\u26A0\uFE0F No hay sesi\xF3n activa para actualizar datos de usuario");return}this.saveSession(e.access_token,e.refresh_token,s)}static \u0275fac=function(e){return new(e||i)};static \u0275prov=a({token:i,factory:i.\u0275fac,providedIn:"root"})};export{f as a};
