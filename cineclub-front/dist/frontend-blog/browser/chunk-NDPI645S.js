import{a as k}from"./chunk-F63DPOLD.js";import{e as w}from"./chunk-NSQ4QIVB.js";import{a as b}from"./chunk-VP7ZHMMA.js";import{l as y}from"./chunk-ZUAAQJ5J.js";import{a as S}from"./chunk-AOTVPSR2.js";import{V as g,_ as c}from"./chunk-4XNWJBNU.js";import{a as d,b as p,i as n}from"./chunk-ODN5LVDJ.js";var T=class f{_notificationsService=c(y);_tokenService=c(k);_supabaseClient=c(S);_supabaseService=c(b);_router=c(w);getUserWithRole(r){return n(this,null,function*(){let i=yield this._supabaseClient.from("profile").select(`
        id,
        roleTypeId,
        roleType:roleType!fk_profile_roletype (
          id,
          code,
          name
        )
      `).eq("id",r).single();if(i.error)throw console.error("\u274C Error obteniendo usuario con rol:",i.error),new Error("No se pudo obtener la informaci\xF3n del usuario");if(!i.data)throw console.error("\u274C No se encontr\xF3 el usuario en la tabla profile"),new Error("Usuario no encontrado");return p(d({},i.data),{roleType:Array.isArray(i.data?.roleType)?i.data?.roleType[0]:i.data?.roleType})})}signIn(r,i){return n(this,null,function*(){try{let{data:e,error:l}=yield this._supabaseClient.auth.signInWithPassword({email:r,password:i});if(l)throw l.message.includes("Invalid login credentials")?new Error("Correo o contrase\xF1a incorrectos."):new Error("Error al iniciar sesi\xF3n.");if(!e.session||!e.user)throw new Error("No se pudo iniciar sesi\xF3n correctamente.");let u=e.user.user_metadata?.avatar_url||e.user.user_metadata?.picture||e.user.identities?.[0]?.identity_data?.avatar_url||e.user.identities?.[0]?.identity_data?.picture,{data:s}=yield this._supabaseClient.from("profile").select("fullName, country, phone, roleTypeId").eq("id",e.user.id).maybeSingle();if(u){let{error:o}=yield this._supabaseClient.from("profile").update({avatarUrl:u}).eq("id",e.user.id);o&&console.error("\u274C Error guardando avatarUrl:",o)}if(!s?.fullName||!s?.country||!s?.phone){let o={id:e.user.id,roleTypeId:"",roleType:{id:"",code:"",name:""}};return this._tokenService.saveSession(e.session.access_token,e.session.refresh_token,o),yield this._router.navigate(["/profile/register-profile"]),this._notificationsService.info("Completa tu perfil antes de continuar."),p(d({},e),{userWithRole:o})}let t=yield this.getUserWithRole(e.user.id);return this._tokenService.saveSession(e.session.access_token,e.session.refresh_token,t),yield new Promise(o=>setTimeout(o,300)),yield this._router.navigate(["/"]),p(d({},e),{userWithRole:t})}catch(e){throw console.error("\u274C Error en signIn:",e),this._notificationsService.error(e.message||"Error iniciando sesi\xF3n."),e}})}signInWithGoogle(){return n(this,null,function*(){try{let{data:r,error:i}=yield this._supabaseClient.auth.signInWithOAuth({provider:"google",options:{redirectTo:"/auth/callback",skipBrowserRedirect:!0}});if(i)throw i;let e=window.open(r?.url,"Login con Google","width=500,height=600,scrollbars=no,resizable=no");return new Promise((l,u)=>{let s=setInterval(()=>n(this,null,function*(){let{data:t}=yield this._supabaseClient.auth.getSession();if(t.session){clearInterval(s),e?.close();let{user:o,access_token:m,refresh_token:v}={user:t.session.user,access_token:t.session.access_token,refresh_token:t.session.refresh_token},_=t.session.user.user_metadata?.avatar_url||t.session.user.user_metadata?.picture||t.session.user.identities?.[0]?.identity_data?.avatar_url||t.session.user.identities?.[0]?.identity_data?.picture,{data:h}=yield this._supabaseClient.from("profile").select("fullName, country, phone, roleTypeId").eq("id",o.id).maybeSingle();if(_){let{error:a}=yield this._supabaseClient.from("profile").update({avatarUrl:_}).eq("id",o.id);a&&console.error("\u274C Error guardando avatarUrl:",a)}if(!h?.fullName||!h?.country||!h?.phone){let a={id:o.id,roleTypeId:"",roleType:{id:"",code:"",name:""}};this._tokenService.saveSession(m,v,a),yield this._router.navigate(["/profile/register-profile"]),this._notificationsService.info("Completa tu perfil antes de continuar."),l(t.session);return}let I=yield this.getUserWithRole(o.id);this._tokenService.saveSession(m,v,I),yield new Promise(a=>setTimeout(a,300)),yield this._router.navigate(["/"]),l(t.session)}}),1e3);setTimeout(()=>{clearInterval(s),e?.close(),u(new Error("Timeout esperando autenticaci\xF3n"))},6e4)})}catch(r){throw console.error("\u274C Error en signInWithGoogle:",r),this._notificationsService.error("Error al iniciar sesi\xF3n con Google."),r}})}signOut(){return n(this,null,function*(){this._tokenService.clearSession(!0),yield new Promise(r=>setTimeout(r,200));try{yield this._supabaseService.signOut(),this._supabaseService.clearUser()}catch(r){r.message?.includes("Auth session missing")||console.error("\u274C Error al cerrar sesi\xF3n en Supabase:",r),this._supabaseService.clearUser()}yield this._router.navigate(["/auth/login"]),yield new Promise(r=>setTimeout(r,100)),this._notificationsService.success("Sesi\xF3n cerrada correctamente.")})}static \u0275fac=function(i){return new(i||f)};static \u0275prov=g({token:f,factory:f.\u0275fac,providedIn:"root"})};export{T as a};
