import{a as ye}from"./chunk-C53J335E.js";import"./chunk-NJIOGT5G.js";import{c as Se}from"./chunk-AXRUWUHH.js";import{a as _e,b as be,c as ve}from"./chunk-UPJF4CXL.js";import{d as j}from"./chunk-W7VLX52Y.js";import"./chunk-XNBUNGCT.js";import{a as ee}from"./chunk-F63DPOLD.js";import{b as de,c as ge}from"./chunk-LYMOFPMC.js";import{A as ce,D as fe,e as te,g as b,j as ie,k as re,o as oe,q as ne,r as ae,t as le,v as me,w as se,x as ue,z as pe}from"./chunk-EK5XN74M.js";import{l as $,m as z,o as J}from"./chunk-J6OIAH2E.js";import"./chunk-E6SG4RJT.js";import{a as U,e as W}from"./chunk-NSQ4QIVB.js";import{a as he}from"./chunk-T3ANTPHN.js";import{a as Z}from"./chunk-VP7ZHMMA.js";import{b as K,c as Q}from"./chunk-JNEX3YXP.js";import{l as X}from"./chunk-ZUAAQJ5J.js";import"./chunk-YUIT4C56.js";import"./chunk-HI5P6VLK.js";import{a as Y}from"./chunk-AOTVPSR2.js";import{Ac as V,Bb as D,Bc as B,C as P,Dc as G,Fc as L,Ga as l,Lb as R,Nc as H,O as w,Pb as n,Rb as F,Sa as k,Xa as y,_ as s,bc as q,c as N,cc as A,da as h,ea as S,gb as f,hb as d,mb as p,nb as i,o as v,ob as t,pb as g,wb as E,yc as O,zb as C}from"./chunk-4XNWJBNU.js";import"./chunk-X5YLR3NI.js";import{a as x,b as T,i as M}from"./chunk-ODN5LVDJ.js";function Ie(r,e){r&1&&(i(0,"mat-error"),n(1,"Los nombre y apellidos es requerido"),t())}function xe(r,e){r&1&&(i(0,"mat-error"),n(1,"El nombre de usuario es requerido"),t())}function Te(r,e){if(r&1){let a=E();i(0,"button",14),C("click",function(){let m;h(a);let u=D();return S((m=u.complementInfo.get("country"))==null?null:m.setValue(""))}),i(1,"mat-icon"),n(2,"close"),t()()}}function Me(r,e){if(r&1&&(i(0,"mat-option",15),n(1),t()),r&2){let a=e.$implicit;p("value",a),l(),F(" ",a," ")}}function Ne(r,e){r&1&&(i(0,"mat-error"),n(1,"El pa\xEDs es requerido"),t())}function Pe(r,e){r&1&&(i(0,"mat-error"),n(1,"El celular es requerido"),t())}function we(r,e){r&1&&(i(0,"span"),n(1,"Guardando..."),t())}function ke(r,e){r&1&&(i(0,"span"),n(1,"Terminar"),t())}var Ee=class r{complementInfo;filteredCountries=new N;countries=[];isSubmitting=!1;_supabaseService=s(Z);_profileService=s(ye);_notificationsService=s(X);_http=s(H);_fb=s(le);_router=s(W);_tokenService=s(ee);_supabaseClient=s(Y);_location=s(O);navigationSubscription;constructor(){this.complementInfo=this._fb.group({fullName:["",[b.required]],country:["",[b.required]],phone:["",[b.required]],username:[""],bibliography:[""],roleTypeId:["ee3609d2-da86-4e9e-84a5-fb8814b17031"]})}ngOnInit(){history.pushState(null,"",location.href),this.navigationSubscription=this._router.events.subscribe(e=>{e instanceof U&&e.navigationTrigger==="popstate"&&(this._notificationsService.info("Debes completar tu perfil antes de continuar"),history.pushState(null,"",location.href))}),this._http.get("https://restcountries.com/v3.1/all?fields=name").pipe(v(e=>e.map(a=>a.name.common).sort()),P(1)).subscribe(e=>{this.countries=e,this.filteredCountries=this.complementInfo.get("country").valueChanges.pipe(w(""),v(a=>this._filterCountries(a||"")))})}ngOnDestroy(){this.navigationSubscription&&this.navigationSubscription.unsubscribe()}_filterCountries(e){let a=e.toLowerCase();return this.countries.filter(o=>o.toLowerCase().includes(a))}registerProfile(){return M(this,null,function*(){if(this.complementInfo.invalid){this.complementInfo.markAllAsTouched(),this._notificationsService.error("Por favor completa todos los campos correctamente");return}if(!this.isSubmitting){this.isSubmitting=!0;try{let e=this._supabaseService.currentUserValue;if(!e){this._notificationsService.error("No se encontr\xF3 usuario autenticado"),this._router.navigate(["/auth/login"]);return}let a={username:this.complementInfo.get("username")?.value,fullName:this.complementInfo.get("fullName")?.value,country:this.complementInfo.get("country")?.value,phone:this.complementInfo.get("phone")?.value,bibliography:this.complementInfo.get("bibliography")?.value,roleTypeId:this.complementInfo.get("roleTypeId")?.value};yield this._profileService.updateProfile(e.id,a);let{data:o,error:m}=yield this._supabaseClient.from("profile").select(`
          id,
          roleTypeId,
          roleType:roleType!fk_profile_roletype (
            id,
            code,
            name
          )
        `).eq("id",e.id).single();if(m||!o)throw console.error("\u274C Error obteniendo rol:",m),new Error("No se pudo obtener el rol del usuario");let u=T(x({},o),{roleType:Array.isArray(o.roleType)?o.roleType[0]:o.roleType}),c=this._tokenService.getSession();c&&this._tokenService.saveSession(c.access_token,c.refresh_token,u),this._notificationsService.success("\xA1Perfil completado exitosamente!"),yield new Promise(_=>setTimeout(_,200)),this._router.navigate(["/"])}catch(e){console.error("Error guardando perfil:",e),this._notificationsService.error("Error al guardar el perfil. Int\xE9ntalo de nuevo.")}finally{this.isSubmitting=!1}}})}static \u0275fac=function(a){return new(a||r)};static \u0275cmp=k({type:r,selectors:[["app-register-profile"]],decls:45,vars:12,consts:[["countryInput",""],["auto","matAutocomplete"],["title","Llena el formulario","subtitle","Ingresa los datos para completar tu perfil"],[1,"mt-2",3,"formGroup"],["appearance","outline",1,"w-full"],["matInput","","formControlName","fullName","type","tel"],["matPrefix",""],["matInput","","formControlName","username","type","tel"],["matInput","","formControlName","bibliography","rows","4","placeholder","Escribe tu biograf\xEDa aqu\xED..."],["matInput","","formControlName","country",3,"matAutocomplete"],["mat-icon-button","","matSuffix","","type","button","aria-label","Borrar pa\xEDs",3,"click",4,"ngIf"],[3,"value",4,"ngFor","ngForOf"],["matInput","","formControlName","phone","type","tel"],["mat-raised-button","","color","primary",1,"!w-full",3,"click","disabled"],["mat-icon-button","","matSuffix","","type","button","aria-label","Borrar pa\xEDs",3,"click"],[3,"value"]],template:function(a,o){if(a&1){let m=E();i(0,"app-auth-card",2)(1,"form",3)(2,"mat-form-field",4)(3,"mat-label"),n(4,"Nombres y apellidos completos"),t(),g(5,"input",5),i(6,"mat-icon",6),n(7,"person"),t(),f(8,Ie,2,0,"mat-error"),t(),i(9,"mat-form-field",4)(10,"mat-label"),n(11,"Nombre de usuario"),t(),g(12,"input",7),i(13,"mat-icon",6),n(14,"person"),t(),f(15,xe,2,0,"mat-error"),t(),i(16,"mat-form-field",4)(17,"mat-label"),n(18,"Bibliograf\xEDa"),t(),g(19,"textarea",8),i(20,"mat-icon",6),n(21,"description"),t()(),i(22,"mat-form-field",4)(23,"mat-label"),n(24,"Pa\xEDs"),t(),i(25,"mat-icon",6),n(26,"public"),t(),g(27,"input",9,0),y(29,Te,3,0,"button",10),i(30,"mat-autocomplete",null,1),y(32,Me,2,2,"mat-option",11),q(33,"async"),t(),f(34,Ne,2,0,"mat-error"),t(),i(35,"mat-form-field",4)(36,"mat-label"),n(37,"Celular"),t(),g(38,"input",12),i(39,"mat-icon",6),n(40,"phone"),t(),f(41,Pe,2,0,"mat-error"),t(),i(42,"button",13),C("click",function(){return h(m),S(o.registerProfile())}),f(43,we,2,0,"span")(44,ke,2,0,"span"),t()()()}if(a&2){let m,u,c,_,I,Ce=R(31);l(),p("formGroup",o.complementInfo),l(7),d((m=o.complementInfo.get("fullName"))!=null&&m.hasError("required")?8:-1),l(7),d((u=o.complementInfo.get("username"))!=null&&u.hasError("required")?15:-1),l(12),p("matAutocomplete",Ce),l(2),p("ngIf",(c=o.complementInfo.get("country"))==null?null:c.value),l(3),p("ngForOf",A(33,10,o.filteredCountries)),l(2),d((_=o.complementInfo.get("country"))!=null&&_.hasError("required")?34:-1),l(7),d((I=o.complementInfo.get("phone"))!=null&&I.hasError("required")?41:-1),l(),p("disabled",o.isSubmitting),l(),d(o.isSubmitting?43:44)}},dependencies:[he,me,oe,te,ie,re,ne,ae,Se,fe,se,ue,pe,ce,j,J,z,$,ve,_e,be,Q,K,ge,de,L,V,B,G],encapsulation:2})};export{Ee as RegisterProfile};
