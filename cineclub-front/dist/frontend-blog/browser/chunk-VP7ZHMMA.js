import{l as d}from"./chunk-ZUAAQJ5J.js";import{a as p}from"./chunk-HI5P6VLK.js";import{V as c,_ as h,g as o}from"./chunk-4XNWJBNU.js";import{i}from"./chunk-ODN5LVDJ.js";var f=class a{supabase=p;currentUser=new o(null);isInitialized=new o(!1);_notificationsService=h(d);authInitialized=!1;constructor(){this.initializeAuth()}initializeAuth(){return i(this,null,function*(){try{let{data:{session:e},error:r}=yield this.supabase.auth.getSession();r?console.error("Error obteniendo sesi\xF3n inicial:",r):this.currentUser.next(e?.user??null),this.supabase.auth.onAuthStateChange((t,n)=>i(this,null,function*(){if(this.currentUser.next(n?.user??null),t==="SIGNED_IN"&&n?.user){let u=localStorage.getItem("pendingUserData");if(u)try{let s=JSON.parse(u),{user:b}=n,{error:l}=yield this.supabase.from("profile").upsert({id:b.id,fullName:s.fullName,country:s.country,phone:s.phone,created_at:new Date});l?console.error("\u274C Error al crear perfil tras confirmar correo:",l):this._notificationsService.success("Tu perfil ha sido creado correctamente"),localStorage.removeItem("pendingUserData")}catch(s){console.error("Error procesando pendingUserData:",s)}}(t==="INITIAL_SESSION"||t==="SIGNED_OUT")&&this.markAsInitialized()})),setTimeout(()=>{this.markAsInitialized()},1e3)}catch(e){console.error("\u274C Error inicializando auth:",e),this.markAsInitialized()}})}markAsInitialized(){this.authInitialized||(this.authInitialized=!0,this.isInitialized.next(!0))}get user$(){return this.currentUser.asObservable()}get currentUserValue(){return this.currentUser.value}get isInitialized$(){return this.isInitialized.asObservable()}getSession(){return i(this,null,function*(){return yield this.supabase.auth.getSession()})}getCurrentSession(){return i(this,null,function*(){let{data:{session:e}}=yield this.supabase.auth.getSession();return e})}waitForAuthReady(){return i(this,null,function*(){return this.authInitialized?!0:new Promise(e=>{let r=this.isInitialized$.subscribe(t=>{t&&(r.unsubscribe(),e(!0))});setTimeout(()=>{r.unsubscribe(),e(!1)},1e3)})})}signOut(){return i(this,null,function*(){try{let{error:e}=yield this.supabase.auth.signOut();e&&!e.message?.includes("Auth session missing")&&console.error("Error en signOut:",e)}catch(e){e.message?.includes("Auth session missing")||console.error("\u274C Error deslogeando:",e)}finally{localStorage.clear(),sessionStorage.clear()}})}clearUser(){this.currentUser.next(null)}static \u0275fac=function(r){return new(r||a)};static \u0275prov=c({token:a,factory:a.\u0275fac,providedIn:"root"})};export{f as a};
