<div class="mt-4">
  <!-- Add Comment Input -->
  <div class="flex gap-2 mb-4">
    <mat-form-field class="w-full md:w-full" appearance="outline">
      <mat-label>Escribe un comentario...</mat-label>
      <textarea
        matInput
        [(ngModel)]="newCommentContent"
        (keyup.enter)="addComment()"
        placeholder="Comparte tu opinión"
        maxlength="500"
        rows="3"
        style="resize: none"
      ></textarea>
      <mat-hint align="end">{{ newCommentContent.length }} / 500</mat-hint>
      <button
        mat-icon-button
        matSuffix
        (click)="addComment()"
        [disabled]="!newCommentContent.trim()"
      >
        <mat-icon>send</mat-icon>
      </button>
    </mat-form-field>
  </div>

  <!-- Loading Spinner -->
  @if (isLoading) {
    <div class="flex justify-center py-4">
      <mat-spinner diameter="30"></mat-spinner>
    </div>
  }

  <!-- Comments List -->
  @if (!isLoading && comments.length === 0) {
    <div class="flex justify-center py-0 text-gray-500 italic">
      Aún no hay comentarios en la review
    </div>
  }

  <div class="flex flex-col gap-4">
    @for (comment of comments; track comment.id) {
      <div class="flex flex-col gap-2 border-t border-gray-200 pt-2">
        <!-- Parent Comment -->
        <div class="flex justify-center items-center gap-1 md:gap-3">
          <!-- Avatar -->
          <div class="hidden md:flex flex-shrink-0">
            <img
              [src]="comment.avatarUrl || '/assets/images/defaultUser.png'"
              class="w-8 h-8 rounded-full object-cover flex-shrink-0 shadow-xl border-[0.5px] border-[#757575]"
              alt="Avatar"
              (error)="onImageError($event)"
            />
          </div>

          <div class="flex-1">
            <div class="bg-none md:bg-gray-100 rounded-none md:rounded-lg p-0 md:p-3">
              <div class="flex w-full justify-start md:justify-between items-center gap-2 md:gap-0">
                <div class="flex md:hidden flex-shrink-0">
                  <img
                    [src]="comment.avatarUrl || '/assets/images/defaultUser.png'"
                    class="w-8 h-8 rounded-full object-cover flex-shrink-0 shadow-xl border-[0.5px] border-[#757575]"
                    alt="Avatar"
                    (error)="onImageError($event)"
                  />
                </div>
                <div class="flex">
                  <span class="font-semibold text-xs md:text-base">{{ comment.userName }}</span>
                </div>
                @if (isOwner(comment)) {
                  <div class="flex">
                    <button mat-icon-button [matMenuTriggerFor]="menu" class="scale-75 -mt-2 -mr-2">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #menu="matMenu" xPosition="before">
                      <button mat-menu-item (click)="startEdit(comment)">
                        <mat-icon>edit</mat-icon>
                        <span>Editar</span>
                      </button>
                      <button mat-menu-item (click)="deleteComment(comment)" class="text-red-600">
                        <mat-icon class="text-red-600">delete</mat-icon>
                        <span>Eliminar</span>
                      </button>
                    </mat-menu>
                  </div>
                }
              </div>
              @if (editingCommentId === comment.id) {
                <div class="mt-2">
                  <mat-form-field class="w-full" appearance="outline">
                    <textarea
                      matInput
                      [(ngModel)]="editContent"
                      (keyup.enter)="saveEdit(comment)"
                      maxlength="500"
                      rows="2"
                      style="resize: none"
                    ></textarea>
                    <mat-hint align="end">{{ editContent.length }} / 500</mat-hint>
                  </mat-form-field>
                  <div class="flex justify-end gap-2 mt-1">
                    <button mat-button (click)="cancelEdit()">Cancelar</button>
                    <button mat-flat-button color="primary" (click)="saveEdit(comment)">
                      Guardar
                    </button>
                  </div>
                </div>
              } @else {
                <!-- Mobile View (< md) -->
                <div class="md:hidden">
                  @if (comment.content.length > 200 && !isCommentExpanded(comment.id)) {
                    <p class="w-full text-xs md:text-sm text-gray-800 mt-1 break-all">
                      {{ comment.content | slice: 0 : 200 }}...
                      <button
                        class="text-[#9811fb] text-xs font-semibold hover:underline ml-1"
                        (click)="toggleCommentExpansion(comment.id)"
                      >
                        Ver más
                      </button>
                    </p>
                  } @else {
                    <p class="w-full text-xs md:text-sm text-gray-800 mt-1 break-all">
                      {{ comment.content }}
                      @if (comment.content.length > 200) {
                        <button
                          class="text-[#9811fb] text-xs font-semibold hover:underline ml-1"
                          (click)="toggleCommentExpansion(comment.id)"
                        >
                          Ver menos
                        </button>
                      }
                    </p>
                  }
                </div>

                <!-- Desktop View (>= md) -->
                <div class="hidden md:block">
                  @if (comment.content.length > 510 && !isCommentExpanded(comment.id)) {
                    <p class="w-full text-xs md:text-sm text-gray-800 mt-1 break-all">
                      {{ comment.content | slice: 0 : 510 }}...
                      <button
                        class="text-[#9811fb] text-xs font-semibold hover:underline ml-1"
                        (click)="toggleCommentExpansion(comment.id)"
                      >
                        Ver más
                      </button>
                    </p>
                  } @else {
                    <p class="w-full text-xs md:text-sm text-gray-800 mt-1 break-all">
                      {{ comment.content }}
                      @if (comment.content.length > 510) {
                        <button
                          class="text-[#9811fb] text-xs font-semibold hover:underline ml-1"
                          (click)="toggleCommentExpansion(comment.id)"
                        >
                          Ver menos
                        </button>
                      }
                    </p>
                  }
                </div>
              }
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-4 mt-1 ml-1 text-xs text-gray-500">
              <div
                class="flex items-center gap-1 cursor-pointer hover:opacity-80 transition-opacity"
                (click)="toggleLike(comment)"
              >
                <mat-icon
                  [ngClass]="
                    comment.liked ? 'text-red-500 hover:text-gray-500' : 'hover:text-red-500'
                  "
                  class="scale-75 transition-transform active:scale-90"
                  >{{ comment.liked ? 'favorite' : 'favorite_border' }}</mat-icon
                >
                <span class="select-none text-xs">{{ comment.likes }}</span>
              </div>

              <button
                class="text-[#9811fb] text-xs font-semibold hover:underline"
                (click)="toggleReply(comment.id)"
              >
                Responder
              </button>

              <span class="text-xs">{{ comment.createdAt | date: 'shortDate' }}</span>
            </div>

            <!-- Reply Input -->
            @if (replyingToId === comment.id) {
              <div class="mt-2 flex gap-2">
                <mat-form-field
                  class="w-full md:w-full"
                  appearance="outline"
                  subscriptSizing="dynamic"
                >
                  <textarea
                    matInput
                    [(ngModel)]="replyContent"
                    (keyup.enter)="sendReply(comment.id)"
                    placeholder="Escribe una respuesta..."
                    autoFocus
                    maxlength="500"
                    rows="2"
                    style="resize: none; min-height: 100px"
                  ></textarea>
                  <mat-hint align="end">{{ replyContent.length }} / 500</mat-hint>
                  <button
                    mat-icon-button
                    matSuffix
                    (click)="sendReply(comment.id)"
                    [disabled]="!replyContent.trim()"
                  >
                    <mat-icon>send</mat-icon>
                  </button>
                </mat-form-field>
              </div>
            }
          </div>
        </div>

        <!-- Replies -->
        @if (comment.replies && comment.replies.length > 0) {
          <div class="ml-2 md:ml-11 flex flex-col gap-2">
            <!-- Toggle Replies Button -->
            <button
              class="w-fit flex items-center gap-1 text-[#9811fb] text-xs font-semibold px-2 py-1"
              (click)="toggleRepliesVisibility(comment.id)"
            >
              <mat-icon
                class="scale-75 w-4 h-4 text-base leading-none flex items-center justify-center"
                >{{ replyVisibility[comment.id] ? 'expand_less' : 'expand_more' }}</mat-icon
              >
              <span class="hover:underline">
                {{
                  replyVisibility[comment.id]
                    ? 'Ocultar respuestas'
                    : 'Ver ' + comment.replies.length + ' respuestas'
                }}
              </span>
            </button>

            @if (replyVisibility[comment.id]) {
              @for (reply of comment.replies; track reply.id) {
                <div class="flex justify-center items-center gap-1 md:gap-3">
                  <!-- Avatar -->
                  <div class="hidden md:flex flex-shrink-0">
                    <img
                      [src]="reply.avatarUrl || '/assets/images/defaultUser.png'"
                      class="w-6 h-6 rounded-full object-cover flex-shrink-0 shadow-xl border-[0.5px] border-[#757575]"
                      alt="Avatar"
                      (error)="onImageError($event)"
                    />
                  </div>

                  <div class="flex-1">
                    <div class="bg-none md:bg-gray-100 rounded-none md:rounded-lg p-0 md:p-2">
                      <div
                        class="flex w-full justify-start md:justify-between items-center gap-2 md:gap-0"
                      >
                        <div class="flex md:hidden flex-shrink-0">
                          <img
                            [src]="reply.avatarUrl || '/assets/images/defaultUser.png'"
                            class="w-6 h-6 rounded-full object-cover flex-shrink-0 shadow-xl border-[0.5px] border-[#757575]"
                            alt="Avatar"
                            (error)="onImageError($event)"
                          />
                        </div>
                        <span class="font-semibold text-xs md:text-base">{{ reply.userName }}</span>
                        @if (isOwner(reply)) {
                          <button
                            mat-icon-button
                            [matMenuTriggerFor]="menuReply"
                            class="scale-75 -mt-2 -mr-2"
                          >
                            <mat-icon class="scale-75">more_vert</mat-icon>
                          </button>
                          <mat-menu #menuReply="matMenu" xPosition="before">
                            <button
                              mat-menu-item
                              (click)="deleteComment(reply)"
                              class="text-red-600"
                            >
                              <mat-icon class="text-red-600">delete</mat-icon>
                              <span>Eliminar</span>
                            </button>
                          </mat-menu>
                        }
                      </div>

                      <!-- Mobile View (< md) -->
                      <div class="md:hidden">
                        @if (reply.content.length > 200 && !isCommentExpanded(reply.id)) {
                          <p class="w-full text-xs md:text-sm text-gray-800 break-all">
                            {{ reply.content | slice: 0 : 200 }}...
                            <button
                              class="text-[#9811fb] text-xs font-semibold hover:underline ml-1"
                              (click)="toggleCommentExpansion(reply.id)"
                            >
                              Ver más
                            </button>
                          </p>
                        } @else {
                          <p class="w-full text-xs md:text-sm text-gray-800 break-all">
                            {{ reply.content }}
                            @if (reply.content.length > 200) {
                              <button
                                class="text-[#9811fb] text-xs font-semibold hover:underline ml-1"
                                (click)="toggleCommentExpansion(reply.id)"
                              >
                                Ver menos
                              </button>
                            }
                          </p>
                        }
                      </div>

                      <!-- Desktop View (>= md) -->
                      <div class="hidden md:block">
                        @if (reply.content.length > 510 && !isCommentExpanded(reply.id)) {
                          <p class="w-full text-xs md:text-sm text-gray-800 break-all">
                            {{ reply.content | slice: 0 : 510 }}...
                            <button
                              class="text-[#9811fb] text-xs font-semibold hover:underline ml-1"
                              (click)="toggleCommentExpansion(reply.id)"
                            >
                              Ver más
                            </button>
                          </p>
                        } @else {
                          <p class="w-full text-xs md:text-sm text-gray-800 break-all">
                            {{ reply.content }}
                            @if (reply.content.length > 510) {
                              <button
                                class="text-[#9811fb] text-xs font-semibold hover:underline ml-1"
                                (click)="toggleCommentExpansion(reply.id)"
                              >
                                Ver menos
                              </button>
                            }
                          </p>
                        }
                      </div>
                    </div>

                    <!-- Actions for Reply -->
                    <div class="flex items-center gap-4 mt-1 ml-1 text-[10px] text-gray-500">
                      <div
                        class="flex items-center gap-1 cursor-pointer hover:opacity-80 transition-opacity"
                        (click)="toggleLike(reply)"
                      >
                        <mat-icon
                          [ngClass]="
                            reply.liked ? 'text-red-500 hover:text-gray-500' : 'hover:text-red-500'
                          "
                          class="scale-75 transition-transform active:scale-90"
                          >{{ reply.liked ? 'favorite' : 'favorite_border' }}</mat-icon
                        >
                        <span class="select-none text-xs">{{ reply.likes }}</span>
                      </div>
                      <span class="text-xs">{{ reply.createdAt | date: 'shortDate' }}</span>
                    </div>
                  </div>
                </div>
              }
            }
          </div>
        }
      </div>
    }
  </div>

  <!-- Load More Button -->
  @if (paginationParams.hasNext && !isLoading) {
    <div class="flex justify-center mt-4">
      <button mat-stroked-button color="primary" (click)="loadMoreComments()">
        Ver más comentarios
      </button>
    </div>
  }

  <!-- Bottom Loading Spinner -->
  @if (isLoading && comments.length > 0) {
    <div class="flex justify-center py-4">
      <mat-spinner diameter="30"></mat-spinner>
    </div>
  }
</div>
